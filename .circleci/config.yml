version: 2.1

defaults: &defaults
    docker:
        - image: circleci/node:12

master: &master
    filters:
        branches:
            only: master

orbs:
    cypress: cypress-io/cypress@1
    grxy:
        commands:
            install:
                steps:
                    - checkout
                    - restore_cache:
                          name: Restore Yarn Package Cache
                          keys:
                              - yarn-packages-{{ checksum "yarn.lock" }}
                    - run: yarn --frozen-lockfile
                    - save_cache:
                          name: Save Yarn Package Cache
                          key: yarn-packages-{{ checksum "yarn.lock" }}
                          paths:
                              - ~/.cache
        executors:
            node:
                docker:
                    - image: circleci/node:12

jobs:
    alias:
        <<: *defaults
        steps:
            - grxy/install
            - run: yarn --silent now alias --token=$NOW_TOKEN
    build:
        <<: *defaults
        steps:
            - grxy/install
            - setup_remote_docker:
                  docker_layer_caching: true
            - run: echo "SKIP_PREFLIGHT_CHECK=true" > ./projects/create-react-app/.env
            - run: yarn build
    danger:
        <<: *defaults
        steps:
            - grxy/install
            - run: yarn danger ci
    deploy:
        <<: *defaults
        steps:
            - grxy/install
            - run: yarn --silent now --token=$NOW_TOKEN
            - run: yarn --silent now --token=$NOW_TOKEN alias grxy-$CIRCLE_SHA1.now.sh
    lint:
        <<: *defaults
        steps:
            - grxy/install
            - run: yarn lint
    release:
        <<: *defaults
        steps:
            - grxy/install
            - checkout
            - run: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc
            - run: git config --global user.email "andrew@grexa.me"
            - run: git config --global user.name "Grex"
            - run: yarn release
    test:
        <<: *defaults
        steps:
            - grxy/install
            - run:
                  command: yarn test --ci --reporters=default --reporters=jest-junit --no-cache
                  environment:
                      JEST_JUNIT_OUTPUT: 'reports/jest/results.xml'
            - store_test_results:
                  path: reports
    # test-integration:
    #     docker:
    #         - image: cypress/browsers:chrome67-ff57
    #     steps:
    #         - grxy/install
    #         - run: yarn cypress install
    #         - run: CYPRESS_baseUrl=https://grxy-$CIRCLE_SHA1.now.sh yarn cypress run

workflows:
    version: 2
    build:
        jobs:
            # - alias:
            #       <<: *master
            #       requires:
            #           - deploy
            #           - release
            # - build
            - cypress/run:
                  build: 'yarn workspace @grxy/next build'
                  command: 'CYPRESS_baseUrl=http://localhost:3000 yarn cypress run'
                  executor: cypress/base-12
                  install-command: 'yarn --frozen-lockfile'
                  post-install:
                      - run: 'yarn cypress install'
                  start: 'yarn workspace @grxy/next start'
                  verify-command: 'yarn cypress verify'
                  wait-on: 'http://localhost:3000'
                  yarn: true
            - danger
            # - deploy
            - lint
            - release:
                  <<: *master
                  requires:
                      #   - build
                      - lint
                      - test
                      #   - test-integration
            - test
            # - test-integration:
            #       requires:
            #           - deploy
